"""
Analiza dziaÅ‚alnoÅ›ci firmy na podstawie tekstu ze strony internetowej.
UÅ¼ywa modelu gemma3:4b przez Ollama + walidacja Pydantic.
"""

import json
import ollama
from enum import Enum
from typing import Optional
from pydantic import BaseModel, Field


# â”€â”€ 1. ENUM: typ dziaÅ‚alnoÅ›ci â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class TypDzialalnosci(str, Enum):
    PRODUKCJA = "produkcja"
    USLUGI = "usÅ‚ugi"
    HANDEL = "handel"
    PRODUKCJA_I_USLUGI = "produkcja i usÅ‚ugi"
    NIEZNANE = "nieznane"


# â”€â”€ 2. ENUM: branÅ¼a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class Branza(str, Enum):
    IT = "IT i technologie"
    BUDOWLANA = "budowlana"
    SPOZYWCZA = "spoÅ¼ywcza"
    MOTORYZACYJNA = "motoryzacyjna"
    MEDYCZNA = "medyczna"
    FARMACEUTYCZNA = "farmaceutyczna"
    EDUKACJA = "edukacja"
    FINANSOWA = "finansowa i bankowa"
    ENERGETYCZNA = "energetyczna"
    CHEMICZNA = "chemiczna"
    MEBLARSKA = "meblarska"
    ODZIEZOWA = "odzieÅ¼owa"
    ELEKTRONICZNA = "elektroniczna"
    METALURGICZNA = "metalurgiczna"
    ROLNICZA = "rolnicza"
    TRANSPORTOWA = "transportowa i logistyczna"
    GASTRONOMICZNA = "gastronomiczna"
    KOSMETYCZNA = "kosmetyczna"
    NIERUCHOMOSCI = "nieruchomoÅ›ci"
    TELEKOMUNIKACYJNA = "telekomunikacyjna"
    ROZRYWKA = "rozrywka i media"
    TURYSTYKA = "turystyka"
    PRAWNICZA = "prawnicza"
    DRUKARSKA = "drukarska i poligraficzna"
    OPAKOWANIOWA = "opakowaniowa"
    INNE = "inna"
    NIEZNANA = "nieznana"


# â”€â”€ 3. MODEL PYDANTIC: wynik analizy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class AnalizaFirmy(BaseModel):
    """Strukturalny wynik analizy dziaÅ‚alnoÅ›ci firmy."""

    typ_dzialalnosci: TypDzialalnosci = Field(
        description="Czy firma zajmuje siÄ™ produkcjÄ…, usÅ‚ugami, handlem, czy kombinacjÄ…?"
    )

    produkty_lub_uslugi: list[str] = Field(
        default_factory=list,
        description="Lista konkretnych produktÃ³w, towarÃ³w lub usÅ‚ug oferowanych przez firmÄ™"
    )

    branza: Branza = Field(
        description="BranÅ¼a, w ktÃ³rej dziaÅ‚a firma"
    )

    material: Optional[str] = Field(
        default=None,
        description="Z jakiego materiaÅ‚u sÄ… produkty firmy. None jeÅ›li brak informacji lub firma Å›wiadczy usÅ‚ugi"
    )

    uzasadnienie: str = Field(
        description="KrÃ³tkie uzasadnienie odpowiedzi (1-2 zdania)"
    )


# â”€â”€ 4. PROMPT SYSTEMOWY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SYSTEM_PROMPT = """JesteÅ› analitykiem biznesowym. Analizujesz teksty ze stron internetowych firm.
Na podstawie podanego tekstu odpowiedz na pytania o firmÄ™.

Odpowiedz WYÅÄ„CZNIE poprawnym JSON-em (bez markdown, bez komentarzy) o nastÄ™pujÄ…cej strukturze:

{
  "typ_dzialalnosci": "<jedna z wartoÅ›ci: produkcja | usÅ‚ugi | handel | produkcja i usÅ‚ugi | nieznane>",
  "produkty_lub_uslugi": ["produkt1", "produkt2"],
  "branza": "<jedna z wartoÅ›ci: IT i technologie | budowlana | spoÅ¼ywcza | motoryzacyjna | medyczna | farmaceutyczna | edukacja | finansowa i bankowa | energetyczna | chemiczna | meblarska | odzieÅ¼owa | elektroniczna | metalurgiczna | rolnicza | transportowa i logistyczna | gastronomiczna | kosmetyczna | nieruchomoÅ›ci | telekomunikacyjna | rozrywka i media | turystyka | prawnicza | drukarska i poligraficzna | opakowaniowa | inna | nieznana>",
  "material": "<materiaÅ‚ lub null jeÅ›li brak informacji>",
  "uzasadnienie": "<krÃ³tkie uzasadnienie>"
}

ZASADY:
- Odpowiadaj TYLKO JSON-em
- JeÅ›li nie ma informacji o materiale, wpisz null
- Lista produktÃ³w moÅ¼e byÄ‡ pusta jeÅ›li brak danych
- BÄ…dÅº precyzyjny i konkretny
"""


# â”€â”€ 5. FUNKCJA ANALIZY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def analizuj_firme(tekst: str, model: str = "gemma3:4b") -> AnalizaFirmy:
    """
    Analizuje tekst ze strony internetowej firmy i zwraca
    strukturalnÄ… odpowiedÅº na 4 pytania o dziaÅ‚alnoÅ›ci.

    Args:
        tekst:  Fragment tekstu ze strony internetowej firmy
        model:  Nazwa modelu Ollama (domyÅ›lnie gemma3:4b)

    Returns:
        AnalizaFirmy â€” zwalidowany obiekt Pydantic
    """

    user_prompt = f"""Przeanalizuj poniÅ¼szy tekst ze strony internetowej firmy i odpowiedz na pytania:

1. Czy firma produkuje produkty, Å›wiadczy usÅ‚ugi, czy zajmuje siÄ™ handlem?
2. Jakie konkretne produkty/towary wytwarza lub jakie usÅ‚ugi Å›wiadczy?
3. W jakiej branÅ¼y dziaÅ‚a firma?
4. Z jakiego materiaÅ‚u sÄ… jej produkty? (jeÅ›li brak informacji â€” null)

TEKST DO ANALIZY:
\"\"\"
{tekst}
\"\"\"

Odpowiedz WYÅÄ„CZNIE poprawnym JSON-em."""

    # â”€â”€ WywoÅ‚anie Ollama â”€â”€
    print(f"â³ WysyÅ‚am zapytanie do modelu {model}...")

    response = ollama.chat(
        model=model,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user",   "content": user_prompt},
        ],
        options={
            "temperature": 0.1,       # niska temperatura = deterministycznoÅ›Ä‡
            "num_predict": 1024,
            'top_k': 2,        # Ogranicza wybÃ³r sÅ‚Ã³w do najbardzie
        },
        format="json",                # wymusza output JSON
    )

    raw_text = response["message"]["content"].strip()
    print(f"âœ… OdpowiedÅº otrzymana ({len(raw_text)} znakÃ³w)\n")

    # â”€â”€ Parsowanie JSON â†’ Pydantic â”€â”€
    try:
        data = json.loads(raw_text)
    except json.JSONDecodeError as e:
        print(f"âŒ BÅ‚Ä…d parsowania JSON: {e}")
        print(f"Surowa odpowiedÅº:\n{raw_text}")
        raise ValueError(f"Model nie zwrÃ³ciÅ‚ poprawnego JSON-a: {e}")

    # Walidacja przez Pydantic
    wynik = AnalizaFirmy.model_validate(data)

    return wynik


# â”€â”€ 6. ÅADNE WYPISYWANIE WYNIKU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def wypisz_wynik(wynik: AnalizaFirmy) -> None:
    """Wypisuje wynik analizy w czytelnej formie."""

    print("=" * 65)
    print("  ğŸ“Š  ANALIZA DZIAÅALNOÅšCI FIRMY")
    print("=" * 65)

    print(f"""
  1ï¸âƒ£  Typ dziaÅ‚alnoÅ›ci:  {wynik.typ_dzialalnosci.value}

  2ï¸âƒ£  Produkty / usÅ‚ugi:""")
    if wynik.produkty_lub_uslugi:
        for p in wynik.produkty_lub_uslugi:
            print(f"       â€¢ {p}")
    else:
        print("       (brak danych)")

    print(f"""
  3ï¸âƒ£  BranÅ¼a:            {wynik.branza.value}

  4ï¸âƒ£  MateriaÅ‚:          {wynik.material or 'brak informacji'}

  ğŸ’¬  Uzasadnienie:      {wynik.uzasadnienie}
""")
    print("=" * 65)

    # JSON output
    print("\nğŸ“„ JSON:\n")
    print(wynik.model_dump_json(indent=2, ensure_ascii=False))


# â”€â”€ 7. MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if __name__ == "__main__":

    # â”€â”€ PrzykÅ‚adowe teksty do testÃ³w â”€â”€

    PRZYKÅADY = {
        "meble": """
            Firma MebloPol sp. z o.o. jest wiodÄ…cym producentem mebli tapicerowanych
            w Polsce. Od ponad 20 lat wytwarzamy sofy, naroÅ¼niki, fotele i Å‚Ã³Å¼ka
            tapicerowane. Nasze produkty wykonane sÄ… z litego drewna bukowego
            i wysokiej jakoÅ›ci pianki poliuretanowej, pokryte tkaninÄ… lub skÃ³rÄ…
            naturalnÄ…. Eksportujemy do 15 krajÃ³w Europy.
        """,

        "it": """
            SoftDev Solutions to firma technologiczna specjalizujÄ…ca siÄ™ w tworzeniu
            oprogramowania na zamÃ³wienie. Oferujemy usÅ‚ugi programistyczne, projektowanie
            aplikacji webowych i mobilnych, wdraÅ¼anie systemÃ³w ERP oraz consulting IT.
            Nasz zespÃ³Å‚ liczy 50 inÅ¼ynierÃ³w pracujÄ…cych w technologiach Python, React
            i cloud computing. ObsÅ‚ugujemy klientÃ³w z sektora finansowego i medycznego.
        """,

        "piekarnia": """
            Piekarnia Tradycyjna "U Janka" to rodzinny zakÅ‚ad rzemieÅ›lniczy dziaÅ‚ajÄ…cy
            od 1985 roku. Wypiekamy chleb na zakwasie, buÅ‚ki, rogale, ciasta i torty.
            UÅ¼ywamy wyÅ‚Ä…cznie naturalnych skÅ‚adnikÃ³w: mÄ…ki z lokalnego mÅ‚yna,
            masÅ‚a, jajek od kur z wolnego wybiegu. Codziennie dostarczamy
            nasze wypieki do 30 sklepÃ³w w regionie.
        """,
    }

    print("\nğŸ” Wybierz przykÅ‚ad lub wpisz wÅ‚asny tekst:\n")
    print("   [1] Firma meblowa")
    print("   [2] Firma IT")
    print("   [3] Piekarnia")
    print("   [4] Wpisz wÅ‚asny tekst")
    print()

    wybor = input("TwÃ³j wybÃ³r (1/2/3/4): ").strip()

    if wybor == "1":
        tekst = PRZYKÅADY["meble"]
    elif wybor == "2":
        tekst = PRZYKÅADY["it"]
    elif wybor == "3":
        tekst = PRZYKÅADY["piekarnia"]
    elif wybor == "4":
        print("\nWklej tekst ze strony internetowej (zakoÅ„cz pustÄ… liniÄ…):\n")
        lines = []
        while True:
            line = input()
            if line == "":
                break
            lines.append(line)
        tekst = "\n".join(lines)
        if not tekst.strip():
            print("âŒ Nie podano tekstu!")
            exit(1)
    else:
        print("âŒ NieprawidÅ‚owy wybÃ³r!")
        exit(1)

    print(f"\nğŸ“ Tekst do analizy:\n{tekst.strip()}\n")

    # â”€â”€ Analiza â”€â”€
    try:
        wynik = analizuj_firme(tekst)
        wypisz_wynik(wynik)
    except Exception as e:
        print(f"\nâŒ BÅ‚Ä…d: {e}")
